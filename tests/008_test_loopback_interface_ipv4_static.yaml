- hosts: all
  become: yes
  vars:
    test_iface_name: lo
    test_address_1: 192.0.2.1/32
    test_address_2: 192.0.2.2/32

    network_configured_interfaces_only: "{{ lookup('env', 'TEST_CONFIGURED_ONLY') | bool }}"
    network_restart_interfaces: "{{ lookup('env', 'TEST_RESTART') | default(False) | bool }}"
    network_interface_restart_reboot: "{{ lookup('env', 'TEST_RESTART_REBOOT') | default(False) | bool }}"

  become: yes

  tasks:

    - name: "Running test [008]"
      debug: msg="[008]"

    - include_tasks: helpers/backup_and_restore_original_network_config.yaml
      vars:
        action: backup
      

    # import_role instead of include_role
    # to make role's variables available in this test
    - import_role:
        name: network_interface
      vars:
        network_ether_interfaces:
          - device: lo
            addresses:
              - 192.0.2.1/32
              - 192.0.2.2/32

    - include_tasks: helpers/debug_pause.yaml

    - name: Compare templated file
      include_tasks: helpers/compare_lines.yaml
      vars:
        compare_lines_from_file: "{{ net_path }}/{{ network_interface_file_prefix }}{{ test_iface_name }}"
        compare_lines_to: |
          auto {{ test_iface_name }}
          iface {{ test_iface_name }} inet loopback
          iface {{ test_iface_name }} inet static
          address {{ test_address_1 }}
          up ip address add dev $IFACE {{ test_address_2 }}
          down ip address del dev $IFACE {{ test_address_2 }}
      when: ansible_os_family == "Debian"

    - include_tasks: helpers/flush_handlers.yaml
      
    - include_tasks: helpers/debug_pause.yaml

    - name: Restart interface
      include_tasks: tasks/system_interface_control.yaml
      vars:
        interface: "{{ test_iface_name }}"
        state: restart

    - name: Test interface has IP address
      include_tasks: tasks/assert_interface_has_ip_address.yaml
      vars:
        addresses:
          - "{{ test_address_1 }}"
          - "{{ test_address_2 }}"
        iface: "{{ test_iface_name }}"

    - name: Stop interface
      include_tasks: tasks/system_interface_control.yaml
      vars:
        interface: "{{ test_iface_name }}"
        state: down
        
    - include_tasks: helpers/debug_pause.yaml
      
    - include_tasks: helpers/backup_and_restore_original_network_config.yaml
      vars:
        action: restore

    - name: Enable original lo interface
      include_tasks: tasks/system_interface_control.yaml
      vars:
        interface: lo
        state: up
