---
# Test configuring ethernet interface with static IPv4 with multiple addresses

- hosts: all
  vars:
    test_iface_name: veth0
    test_ip_addresses:
      - 192.0.2.2/24
      - 192.0.2.3/24
      - 192.0.2.4/24

    network_restart_interfaces: "{{ lookup('env', 'TEST_RESTART') | default(False) | bool }}"
    network_interface_restart_reboot: "{{ lookup('env', 'TEST_RESTART_REBOOT') | default(False) | bool }}"

    network_interface_restart_via_handlers: false

  become: yes
  tasks:

    - name: "Running test [003]"
      debug: msg="[003]"

    - include_tasks: helpers/backup_and_restore_original_network_config.yaml
      vars:
        action: backup

    - name: Add test interface
      include_tasks: helpers/manage_test_interface.yaml
      vars:
        interface: "{{ test_iface_name }}"
        type: veth
        state: present
      
    - import_role:
        name: network_interface
      #become: yes
      vars:
        network_ether_interfaces:
          - device: "{{ test_iface_name }}"
            addresses: "{{ test_ip_addresses }}"

    - include_tasks: helpers/flush_handlers.yaml

    - include_tasks: helpers/debug_pause.yaml

    - name: Start interface
      include_tasks: tasks/system_interface_control.yaml
      vars:
        interface: "{{ test_iface_name }}"
        state: up
        
    - name: Test interface is up
      include_tasks: tasks/test_interface_state.yaml
      vars:
        interface: "{{ test_iface_name }}"
        state: up

    - name: Test interface has IP address
      include_tasks: tasks/assert_interface_has_ip_address.yaml
      vars:
        addresses: "{{ test_ip_addresses }}"
        iface: "{{ test_iface_name }}"

    - name: Stop interface
      include_tasks: tasks/system_interface_control.yaml
      vars:
        interface: "{{ test_iface_name }}"
        state: down

    - name: Assert interface is down
      include_tasks: tasks/test_interface_state.yaml
      vars:
        interface: "{{ test_iface_name }}"
        state: down

    # - name: Test removing interface configuration
    #   import_role:
    #     name: network_interface
    #   become: yes
    #   vars:
    #     network_ether_interfaces:
    #       - device: "{{ test_iface_name }}"
    #         present: no

    # - name: Test interface configuration is absent
    #   include_tasks: tasks/test_interface_config_is_absent.yaml

    - name: Remove test interface
      include_tasks: helpers/manage_test_interface.yaml
      vars:
        interface: "{{ test_iface_name }}"
        type: veth
        state: absent

    - include_tasks: helpers/backup_and_restore_original_network_config.yaml
      vars:
        action: restore
        
