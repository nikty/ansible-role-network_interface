- hosts: all
  vars:

  become: yes
  tasks:

    - include_tasks: helpers/set_test_variables.yaml

    - include_tasks: helpers/backup_and_restore_original_network_config.yaml
      vars:
        action: backup

    - name: Add test interface
      include_tasks: helpers/manage_test_interface.yaml
      vars:
        interface: veth0
        type: veth
        state: present

    - name: Add test interface
      include_tasks: helpers/manage_test_interface.yaml
      vars:
        interface: veth10
        type: veth
        state: present

    - name: Add test interface
      include_tasks: helpers/manage_test_interface.yaml
      vars:
        interface: veth11
        type: veth
        state: present

    - import_role:
        name: network_interface
      vars:
        
        network_ether_interfaces:
          # Management
          - device: veth0
            addresses:
              - 172.19.9.58/30
            debian_command_options:
              - post-up ip route add table 1000 default via 172.19.9.57 || true
              - |
                post-up [ -z "$(ip rule ls from 172.19.9.58/30 table 1000)" ] && \
                    ip rule add from 172.19.9.58/30 table 1000 || true
            description: "mgmt"
        
        
          # Loopback
          - device: lo
            addresses:
              - 172.16.123.232/32
            debian_command_options:
              #- post-up ip address add dev $IFACE 10.0.0.1/32 || true
              - post-up ip rule del from all lookup main || true
              - post-up ip rule add from all lookup main pref 32000 || true
              - post-up ip rule add from all iif lo lookup 1000 pref 32100 || true
        
          # To internet
          - device: veth10
            addresses:
              - 172.16.100.245/31
              - 2a01:590:0:1::26/127
            debian_command_options:
              - pre-up ethtool -G $IFACE rx 4096 tx 4096 || true
            description: "to internet"
        
        network_vlan_interfaces:
          # To clients
          - device: veth11.1730
            addresses:
              - 172.16.100.246/31
              - 2a01:590:0:1::25/127
            debian_command_options:
              - pre-up ethtool -G $IFACE rx 4096 tx 4096 || true
            description: to clients
        
          # Service delayed
          - device: veth11.934
            addresses:
              - 85.114.3.162/28
            debian_command_options:
              - post-up ip route add table 5 default via 85.114.3.166 || true
              - |
                post-up ip rule ls | grep 'from all fwmark 0x5 lookup 5' >/dev/null 2>&1 || \
                        ip rule add fwmark 0x5 table 5 || true
            description: service delayed
            
    - name: debug pause after role has run
      include_tasks: helpers/debug_pause.yaml

    - include_tasks: helpers/flush_handlers.yaml
      when: network_restart_interfaces

    - name: Add test interface
      include_tasks: helpers/manage_test_interface.yaml
      vars:
        interface: veth0
        type: veth
        state: absent

    - name: Add test interface
      include_tasks: helpers/manage_test_interface.yaml
      vars:
        interface: veth10
        type: veth
        state: absent

    - name: Add test interface
      include_tasks: helpers/manage_test_interface.yaml
      vars:
        interface: veth11
        type: veth
        state: absent

    - name: Stop interfaces
      include_tasks: tasks/system_interface_control.yaml
      vars:
        interface: "{{ item }}"
        state: down
      loop:
        - lo
        - veth0
        - veth10
        - veth11.1730
        - veth11.934

    - include_tasks: helpers/backup_and_restore_original_network_config.yaml
      vars:
        action: restore

    - name: Restart lo interface
      include_tasks: tasks/system_interface_control.yaml
      vars:
        interface: lo
        state: restart
        
