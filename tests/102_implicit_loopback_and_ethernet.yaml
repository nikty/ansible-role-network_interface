- hosts: all
  vars:
  become: yes
  tasks:

    - include_tasks: helpers/set_test_variables.yaml
      
    - include_tasks: helpers/backup_and_restore_original_network_config.yaml
      vars:
        action: backup

    - name: Add test interface
      include_tasks: helpers/manage_test_interface.yaml
      vars:
        interface: veth0
        type: veth
        state: present


    - name: Configure loopback only
      import_role:
        name: network_interface
      vars:
        network_ether_interfaces:
          - device: veth0
            addresses:
              - 192.0.2.1/24
            debian_command_options:
              - up true || true
              - down true || true
              

    - name: debug pause after role has run
      include_tasks: helpers/debug_pause.yaml

    - include_tasks: helpers/flush_handlers.yaml      

    - block:
        - name: Test
          include_tasks: helpers/compare_lines.yaml
          vars:
            compare_lines_from_file: "{{ net_path }}/{{ network_interface_file_prefix }}{{ network_interface_loopback_name }}{{ network_interface_file_postfix }}"
            compare_lines_to: |
              auto lo
              iface lo inet loopback
              
      when:
        - ansible_distribution == "Debian"
        - network_interface_configured_only | bool
        - network_interface_implicit_loopback | bool

    - include_tasks: helpers/compare_lines.yaml
      vars:
        compare_lines_from_file: "{{ net_path }}/{{ network_interface_file_prefix }}{{ 'veth0' }}{{ network_interface_file_postfix }}"
        compare_lines_to: |
          auto veth0
          iface veth0 inet static
          address 192.0.2.1/24

          up true || true
          down true || true
      
    - include_tasks: helpers/manage_test_interface.yaml
      vars:
        interface: veth0
        type: veth
        state: absent
        
      
    - include_tasks: helpers/backup_and_restore_original_network_config.yaml
      vars:
        action: restore
